# IC-Light

IC-Light 是一个用于操控图像光照效果的项目。

项目名称 "IC-Light" 代表 **"Imposing Consistent Light"**（我们将在页面末尾简要说明这一点）。

目前，我们发布了两类模型：基于文本条件的光照重设模型和基于背景条件的模型。两种类型都以前景图像作为输入。

**请注意，"iclightai dot com" 是一个诈骗网站。他们与我们没有任何关系。请不要给诈骗网站付款！这个 GitHub 仓库是 IC-Light 的唯一官方渠道。**

# 目录

1. [项目概述](#项目概述)
2. [快速开始](#快速开始)
3. [详细使用指南](#详细使用指南)
4. [技术文档](#技术文档)
5. [常见问题](#常见问题)
6. [最佳实践](#最佳实践)
7. [技术栈](#技术栈)
8. [许可证](#许可证)

# 项目概述

## 1. 主要功能
- 图像光照重设：精确控制图像的光照效果
- 背景移除和替换：自动处理背景，支持自定义背景
- 自定义光照效果：支持多种光照场景和效果
- 批量处理支持：可同时处理多张图片

## 2. 模型类型
1. 基于文本条件的光照重设模型
   - 通过文本提示词控制光照效果
   - 支持多种光照场景
   - 精确的光照方向控制
   - 适合需要精确控制光照效果的场景

2. 基于背景条件的模型
   - 使用背景图像控制光照效果
   - 更自然的光照过渡
   - 支持自定义背景
   - 适合需要特定背景光照效果的场景

## 3. 核心优势
- 高质量光照效果
- 简单易用的界面
- 灵活的参数控制
- 快速的处理速度
- 广泛的应用场景

# 快速开始

## 1. 系统要求
- Windows/Linux/macOS 操作系统
- NVIDIA GPU（推荐 RTX 3060 或更高）
- CUDA 12.1 或更高版本
- 至少 16GB 系统内存
- 至少 20GB 可用磁盘空间

## 2. 安装步骤
1. 克隆仓库：
```bash
git clone https://github.com/lllyasviel/IC-Light.git
cd IC-Light
```

2. 创建并激活 Conda 环境：
```bash
conda create -n iclight python=3.10
conda activate iclight
```

3. 安装 PyTorch：
```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
```

4. 安装其他依赖：
```bash
pip install -r requirements.txt
```

## 3. 启动程序
1. 基于文本条件的光照重设：
```bash
python gradio_demo.py
```

2. 基于背景条件的光照重设：
```bash
python gradio_demo_bg.py
```

## 4. 快速上手
1. 准备一张清晰的图片
2. 选择合适的光照效果
3. 调整参数
4. 生成结果

# 详细使用指南

## 1. 界面说明

### 1.1 两种模式的区别

#### 1.1.1 文本条件模式（gradio_demo.py）
- **光照控制**：通过文本提示词和光照偏好控制光照效果
- **背景处理**：自动移除背景，生成新的背景
- **适用场景**：需要精确控制光照效果的场景
- **优势**：
  - 更精确的光照控制
  - 更丰富的场景选择
  - 更灵活的参数调整

#### 1.1.2 背景条件模式（gradio_demo_bg.py）
- **背景控制**：通过上传背景图片控制光照效果
- **背景选项**：
  - 使用背景图片
  - 使用翻转的背景图片
  - 使用预设背景
  - 使用环境光
- **适用场景**：需要特定背景光照效果的场景
- **优势**：
  - 更自然的光照过渡
  - 更真实的场景效果
  - 更简单的操作流程

### 1.2 输入区域
- **图片上传**：点击上传区域或拖拽图片到指定位置
- **提示词输入**：在文本框中输入描述所需光照效果的提示词
- **光照偏好**：选择光照方向（左、右、上、下）
- **快速提示词列表**：
  - 主体快速列表：包含常用主体描述
  - 光照快速列表：包含常用光照效果描述
- **预处理预览**：显示背景移除后的前景图像

### 1.3 参数调节
- **图片数量**：设置生成图片的数量（1-12张）
- **随机种子**：控制生成结果的随机性
- **图片尺寸**：
  - 宽度：256-1024像素（64像素步进）
  - 高度：256-1024像素（64像素步进）

### 1.4 高级选项

#### 1.4.1 生成参数
- **步数（Steps）**：
  - 范围：1-100
  - 默认值：25
  - 作用：控制生成过程的迭代次数
  - 建议：
    - 25-35步：适合快速预览
    - 35-50步：适合一般使用
    - 50步以上：适合追求高质量效果
  - 影响：
    - 步数越多，生成质量越好，但耗时更长
    - 步数过少可能导致细节不足
    - 步数过多可能导致过度处理

- **CFG比例（CFG Scale）**：
  - 范围：1.0-32.0
  - 默认值：2.0
  - 作用：控制提示词对生成结果的影响强度
  - 建议：
    - 1.0-3.0：保持主体特征
    - 3.0-7.0：增强光照效果
    - 7.0以上：强烈光照效果
  - 影响：
    - 值越大，提示词影响越强
    - 值越小，保持原始特征越好
    - 过高可能导致主体变形

#### 1.4.2 降噪参数
- **低分辨率降噪（Lowres Denoise）**：
  - 范围：0.1-1.0
  - 默认值：0.9
  - 作用：控制初始潜变量的降噪强度
  - 建议：
    - 0.7-0.9：适合大多数场景
    - 0.5-0.7：适合保持更多细节
    - 0.9-1.0：适合完全重设光照
  - 影响：
    - 值越大，初始光照影响越小
    - 值越小，保留更多原始特征
    - 影响最终光照效果的强度

- **高分辨率降噪（Highres Denoise）**：
  - 范围：0.1-1.0
  - 默认值：0.5
  - 作用：控制最终图片的降噪强度
  - 建议：
    - 0.3-0.5：适合保持细节
    - 0.5-0.7：适合一般使用
    - 0.7-0.9：适合完全重设
  - 影响：
    - 值越大，细节重设越彻底
    - 值越小，保留更多原始细节
    - 影响最终图片的清晰度

#### 1.4.3 分辨率参数
- **高分辨率缩放（Highres Scale）**：
  - 范围：1.0-3.0
  - 默认值：1.5
  - 作用：控制最终图片的放大比例
  - 建议：
    - 1.0：保持原始分辨率
    - 1.5：适合一般使用
    - 2.0以上：适合高质量输出
  - 影响：
    - 值越大，图片分辨率越高
    - 值越大，处理时间越长
    - 值越大，显存占用越多

#### 1.4.4 提示词参数
- **附加提示词（Added Prompt）**：
  - 默认值：'best quality'
  - 作用：添加额外的质量提升提示词
  - 建议：
    - 保持默认值即可
    - 可添加 'high quality', 'detailed' 等
    - 避免添加过多提示词
  - 影响：
    - 影响整体生成质量
    - 可能影响处理速度
    - 建议保持简洁

- **负面提示词（Negative Prompt）**：
  - 默认值：'lowres, bad anatomy, bad hands, cropped, worst quality'
  - 作用：指定需要避免的特征
  - 建议：
    - 保持默认值即可
    - 可添加 'deformed', 'distorted' 等
    - 根据具体需求调整
  - 影响：
    - 帮助避免不良特征
    - 提高生成质量
    - 影响生成速度

#### 1.4.5 参数组合建议
1. 快速预览：
```
步数：25
CFG比例：2.0
低分辨率降噪：0.9
高分辨率降噪：0.5
高分辨率缩放：1.0
```

2. 标准质量：
```
步数：35
CFG比例：3.0
低分辨率降噪：0.8
高分辨率降噪：0.5
高分辨率缩放：1.5
```

3. 高质量输出：
```
步数：50
CFG比例：4.0
低分辨率降噪：0.7
高分辨率降噪：0.4
高分辨率缩放：2.0
```

4. 保持主体特征：
```
步数：40
CFG比例：2.0
低分辨率降噪：0.6
高分辨率降噪：0.3
高分辨率缩放：1.5
```

5. 强烈光照效果：
```
步数：45
CFG比例：7.0
低分辨率降噪：0.9
高分辨率降噪：0.6
高分辨率缩放：1.5
```

### 1.5 输出区域
- **结果展示**：以画廊形式展示生成的图片
- **图片预览**：支持点击查看大图
- **批量下载**：支持批量下载生成的图片

### 1.6 示例功能
- **内置示例**：提供多个预设示例
- **示例预览**：点击示例可快速加载参数
- **示例分页**：支持多页示例浏览

### 1.7 快捷操作
- **一键重设**：点击 "Relight" 按钮开始处理
- **快速选择**：点击快速列表中的项目自动填充提示词
- **参数重置**：支持重置所有参数到默认值

### 1.8 背景条件模式特有功能
- **背景上传**：支持上传自定义背景图片
- **背景翻转**：支持水平翻转背景图片
- **背景预设**：提供多个预设背景供选择
- **法线计算**：支持计算图像法线（处理时间较长）
- **背景快速列表**：提供常用背景图片快速选择
- **环境光选项**：支持使用纯色环境光

### 1.9 文本条件模式特有功能
- **主体快速列表**：提供常用主体描述快速选择
- **光照快速列表**：提供常用光照效果描述快速选择
- **光照偏好**：支持选择光照方向（左、右、上、下）
- **预处理预览**：显示背景移除后的前景图像

## 2. 使用技巧

### 2.1 提示词编写
1. 基本格式：
   - 主体描述 + 光照效果描述
   - 示例：`beautiful woman, detailed face, warm atmosphere, at home, bedroom`

2. 常用光照效果：
   - 自然光：`natural lighting, sunshine`
   - 室内光：`warm atmosphere, at home, bedroom`
   - 霓虹灯：`neon light, city`
   - 日落：`sunset over sea`
   - 窗户光：`sunshine from window, shadow from window`
   - 工作室光：`soft studio lighting`

### 2.2 参数调整建议
1. 图片质量：
   - 步数：建议 25-50 步
   - CFG比例：建议 2-7
   - 高分辨率缩放：建议 1.5-2.0

2. 处理速度：
   - 降低步数
   - 减小图片尺寸
   - 减少生成数量

3. 光照效果：
   - 强光照：增加 CFG 比例
   - 柔和光照：降低 CFG 比例
   - 细节保持：增加步数

### 2.3 保持主体完整性

#### 2.3.1 提示词优化
1. 主体描述：
   - 使用详细的主体描述词
   - 添加保持特征的提示词
   - 使用负面提示词避免变形

2. 光照效果描述：
   - 将光照效果放在主体描述之后
   - 使用温和的光照描述词
   - 避免使用过于强烈的光照词

#### 2.3.2 参数调整
1. CFG 比例：建议 2-5
2. 降噪强度：低分辨率 0.7-0.9，高分辨率 0.3-0.5
3. 步数选择：建议 30-50 步

### 2.4 自定义背景使用

#### 2.4.1 背景图要求
1. 图片格式：支持 JPG、PNG
2. 图片质量：分辨率建议 512x512 以上
3. 图片内容：选择与目标光照效果匹配的背景

#### 2.4.2 使用步骤
1. 准备背景图
2. 在界面中使用
3. 调整参数

#### 2.4.3 最佳实践
1. 室内场景
2. 室外场景
3. 特殊效果

# 技术文档

## 1. 模型详解

### 1.1 基础模型架构

#### 1.1.1 Stable Diffusion 基础
- **模型名称**：`stablediffusionapi/realistic-vision-v51`
- **基础架构**：Stable Diffusion 1.5
- **主要组件**：
  - CLIPTokenizer：文本编码器
  - CLIPTextModel：文本理解模型
  - AutoencoderKL：图像编解码器
  - UNet2DConditionModel：扩散模型主体
- **特点**：
  - 支持高分辨率图像生成
  - 优化的注意力机制
  - 混合精度训练支持

#### 1.1.2 背景移除模型
- **模型名称**：`briaai/RMBG-1.4`
- **架构**：基于 RSU (Residual U-Net) 的深度网络
- **主要特点**：
  - 多尺度特征提取
  - 残差连接结构
  - 自适应池化层
- **使用限制**：仅限非商业用途

### 1.2 IC-Light 专用模型

#### 1.2.1 文本条件模型
- **模型文件**：`iclight_sd15_fc.safetensors`
- **功能**：
  - 基于文本提示词控制光照
  - 支持多种光照场景
  - 精确的光照方向控制
- **性能特点**：
  - 处理速度：约 2-3 秒/张（RTX 3060）
  - 显存占用：约 4-6GB
  - 支持分辨率：最高 1024x1024

#### 1.2.2 背景条件模型
- **模型文件**：`iclight_sd15_fbc.safetensors`
- **功能**：
  - 基于背景图像控制光照
  - 支持自定义背景
  - 环境光模拟
- **性能特点**：
  - 处理速度：约 3-4 秒/张（RTX 3060）
  - 显存占用：约 6-8GB
  - 支持分辨率：最高 1024x1024

#### 1.2.3 偏移噪声版本
- **模型文件**：`iclight_sd15_fcon.safetensors`
- **特点**：
  - 添加了偏移噪声训练
  - 可能提供更自然的光照过渡
  - 处理速度略慢于标准版本

### 1.3 模型依赖关系

```
基础模型
├── Stable Diffusion 1.5
│   ├── CLIP 文本编码器
│   ├── VAE 图像编解码器
│   └── UNet 扩散模型
├── Realistic Vision v5.1
│   └── 优化的 UNet 结构
└── BriaRMBG 1.4
    └── 背景移除网络
```

### 1.4 模型性能指标

#### 1.4.1 处理速度
- **文本条件模式**：
  - 512x512：约 2 秒/张
  - 768x768：约 3 秒/张
  - 1024x1024：约 5 秒/张

- **背景条件模式**：
  - 512x512：约 3 秒/张
  - 768x768：约 4 秒/张
  - 1024x1024：约 6 秒/张

#### 1.4.2 资源占用
- **显存使用**：
  - 最小：4GB
  - 推荐：8GB
  - 最佳：12GB 以上

- **系统内存**：
  - 最小：8GB
  - 推荐：16GB
  - 最佳：32GB 以上

### 1.5 模型下载与安装

#### 1.5.1 自动下载
- 首次运行程序时自动下载所需模型
- 下载位置：`./models/` 目录
- 需要稳定的网络连接

#### 1.5.2 手动下载
1. 基础模型：
   - 访问 Hugging Face 下载
   - 放置于 `./models/` 目录

2. IC-Light 模型：
   - 从官方仓库下载
   - 放置于 `./models/` 目录

#### 1.5.3 文件大小
- `iclight_sd15_fc.safetensors`：约 4GB
- `iclight_sd15_fbc.safetensors`：约 4GB
- `iclight_sd15_fcon.safetensors`：约 4GB
- 基础模型：约 8GB
- 背景移除模型：约 1GB

### 1.6 使用限制

#### 1.6.1 商业使用
- BriaRMBG 模型仅限非商业用途
- 其他模型可商业使用
- 建议使用替代背景移除模型进行商业项目

#### 1.6.2 硬件要求
- GPU：NVIDIA GPU（推荐 RTX 3060 或更高）
- 显存：至少 8GB
- 系统内存：至少 16GB
- 存储空间：至少 20GB 可用空间

#### 1.6.3 软件要求
- CUDA 12.1 或更高版本
- Python 3.10
- PyTorch 2.0 或更高版本 

## 2. 项目结构

```
IC-Light/
├── gradio_demo.py          # 基于文本条件的主演示程序
├── gradio_demo_bg.py       # 基于背景条件的演示程序
├── briarmbg.py            # 背景移除模型实现
├── db_examples.py         # 示例数据
├── models/                # 模型文件目录
├── imgs/                  # 图片资源目录
└── requirements.txt       # 项目依赖
```

## 3. 主要功能

1. 图像光照重设
   - 支持多种光照效果：自然光、室内光、霓虹灯等
   - 可调节光照方向和强度
   - 保持图像细节和纹理

2. 背景处理
   - 自动背景移除
   - 支持自定义背景
   - 智能边缘处理

3. 用户界面
   - 直观的图片上传界面
   - 实时预览功能
   - 参数调节面板
   - 批量处理功能

## 4. 技术特点

1. 模型架构
   - 基于 Stable Diffusion 架构
   - 使用 Realistic Vision v5.1 作为基础模型
   - 自定义 UNet 结构支持光照控制

2. 图像处理
   - 支持高分辨率图像处理
   - 智能图像缩放和裁剪
   - 多阶段处理流程

3. 性能优化
   - GPU 加速支持
   - 批处理能力
   - 内存优化

# 常见问题

## 1. 显存不足
- 降低图片尺寸
- 减少生成数量
- 关闭其他占用显存的程序

## 2. 生成质量不理想
- 检查提示词是否合适
- 增加生成步数
- 调整 CFG 比例
- 尝试不同的光照偏好

## 3. 程序启动失败
- 检查 CUDA 版本
- 确认所有依赖已正确安装
- 检查 Python 版本是否为 3.10

# 最佳实践

1. 图片准备：
   - 使用清晰的前景图片
   - 图片尺寸建议 512x640 或 640x512
   - 避免过于复杂的背景

2. 提示词使用：
   - 使用英文提示词
   - 包含主体描述和光照效果
   - 可以组合多个光照效果

3. 参数选择：
   - 首次尝试使用默认参数
   - 根据效果逐步调整
   - 保存效果好的参数组合

4. 批量处理：
   - 使用相同的参数处理多张图片
   - 记录效果好的参数组合
   - 注意显存使用情况

### 2.6 保持主体完整性

#### 2.6.1 提示词优化
1. 主体描述：
   - 使用详细的主体描述词，如 `detailed face, high quality, sharp focus`
   - 添加保持特征的提示词，如 `keep original features, maintain identity`
   - 使用负面提示词避免变形，如 `deformed, distorted, mutated`

2. 光照效果描述：
   - 将光照效果放在主体描述之后
   - 使用温和的光照描述词，如 `soft lighting, gentle light`
   - 避免使用过于强烈的光照词，如 `extreme lighting, harsh light`

#### 2.6.2 参数调整
1. CFG 比例：
   - 建议使用 2-5 之间的值
   - 值越大，光照效果越强，但可能影响主体
   - 值越小，主体保持越好，但光照效果可能较弱

2. 降噪强度：
   - 低分辨率降噪：建议 0.7-0.9
   - 高分辨率降噪：建议 0.3-0.5
   - 过高的降噪值可能导致主体细节丢失

3. 步数选择：
   - 建议使用 30-50 步
   - 步数过少可能导致主体变形
   - 步数过多可能过度改变主体

#### 2.6.3 图片准备
1. 主体选择：
   - 使用清晰、高质量的前景图片
   - 确保主体轮廓清晰
   - 避免使用模糊或低分辨率的图片

2. 背景处理：
   - 使用背景移除工具预处理图片
   - 确保主体边缘干净
   - 避免复杂的背景干扰

#### 2.6.4 光照偏好选择
1. 方向选择：
   - 根据原始图片的光照方向选择
   - 避免选择与原始光照完全相反的方向
   - 可以尝试多个方向，选择效果最好的

2. 强度控制：
   - 使用 `soft`、`gentle` 等词控制光照强度
   - 可以组合多个温和的光照效果
   - 避免使用过于强烈的光照效果

#### 2.6.5 常见问题解决
1. 主体变形：
   - 降低 CFG 比例
   - 增加主体相关的提示词权重
   - 使用更详细的主体描述

2. 细节丢失：
   - 增加步数
   - 降低降噪强度
   - 添加细节保持相关的提示词

3. 光照过强：
   - 降低 CFG 比例
   - 使用更温和的光照描述词
   - 调整降噪参数

#### 2.6.6 最佳实践组合
1. 温和光照：
```
主体描述 + detailed face + soft lighting + gentle light + keep original features
CFG: 3-4
步数: 35-40
降噪: 0.7/0.4
```

2. 自然光照：
```
主体描述 + detailed face + natural lighting + soft sunshine + maintain identity
CFG: 2-3
步数: 30-35
降噪: 0.8/0.3
```

3. 室内光照：
```
主体描述 + detailed face + warm atmosphere + soft indoor lighting + keep original features
CFG: 3-4
步数: 35-40
降噪: 0.7/0.4
```

### 2.7 自定义背景使用指南

#### 2.7.1 背景图要求
1. 图片格式：
   - 支持 JPG、PNG 格式
   - 建议使用 PNG 格式以保持透明度
   - 避免使用 GIF 等动态图片

2. 图片质量：
   - 分辨率建议 512x512 以上
   - 避免使用模糊或低质量的图片
   - 确保背景图清晰度与前景图匹配

3. 图片内容：
   - 选择与目标光照效果匹配的背景
   - 避免过于复杂的背景图案
   - 建议使用渐变或简单的背景

#### 2.7.2 使用步骤
1. 准备背景图：
   - 将背景图调整为合适的尺寸
   - 确保背景图与前景图比例匹配
   - 可以预先处理背景图的光照效果

2. 在界面中使用：
   - 选择 "基于背景条件" 的演示程序
   - 上传处理好的背景图
   - 调整背景图的位置和大小

3. 参数调整：
   - 背景强度：控制背景对最终效果的影响
   - 光照混合：调整背景光照与前景的融合程度
   - 边缘处理：确保前景与背景的自然过渡

#### 2.7.3 背景图处理技巧
1. 光照匹配：
   - 选择与目标光照方向一致的背景
   - 调整背景的亮度和对比度
   - 确保背景光照效果自然

2. 颜色协调：
   - 选择与前景色调协调的背景
   - 避免使用过于鲜艳或对比强烈的背景
   - 可以使用渐变背景创造柔和过渡

3. 边缘处理：
   - 使用羽化效果处理边缘
   - 确保前景与背景的自然过渡
   - 避免明显的拼接痕迹

#### 2.7.4 常见问题解决
1. 背景不自然：
   - 调整背景强度参数
   - 选择更合适的背景图
   - 使用渐变或模糊效果

2. 光照不协调：
   - 调整背景光照参数
   - 选择光照方向一致的背景
   - 使用光照混合参数调整

3. 边缘问题：
   - 调整边缘处理参数
   - 使用羽化效果
   - 选择更简单的背景

#### 2.7.5 最佳实践
1. 室内场景：
```
背景选择：
- 简单的室内背景
- 柔和的光照效果
- 温暖的色调

参数设置：
- 背景强度：0.7-0.8
- 光照混合：0.5-0.6
- 边缘处理：0.3-0.4
```

2. 室外场景：
```
背景选择：
- 自然风景背景
- 自然光照效果
- 适当的景深

参数设置：
- 背景强度：0.6-0.7
- 光照混合：0.4-0.5
- 边缘处理：0.2-0.3
```

3. 特殊效果：
```
背景选择：
- 渐变背景
- 抽象图案
- 特殊光照效果

参数设置：
- 背景强度：0.5-0.6
- 光照混合：0.3-0.4
- 边缘处理：0.4-0.5
```

#### 2.7.6 提示词配合
1. 背景相关提示词：
   - `with background, seamless integration`
   - `natural background blending`
   - `environmental lighting`

2. 光照效果提示词：
   - `background lighting, ambient light`
   - `environmental illumination`
   - `scene lighting`

3. 整体效果提示词：
   - `cohesive scene, unified lighting`
   - `harmonious composition`
   - `natural integration`

# 技术栈

## 核心框架
- Python 3.10
- PyTorch (CUDA 12.1)
- Gradio (Web UI)

## 主要依赖
- diffusers: Stable Diffusion 模型支持
- transformers: 文本编码器
- opencv-python: 图像处理
- safetensors: 模型权重存储
- pillow: 图像处理
- einops: 张量操作
- peft: 参数高效微调
- protobuf: 数据序列化

## 模型组件
- Stable Diffusion v1.5
- Realistic Vision v5.1
- BriaRMBG (背景移除)
- CLIP (文本编码)

## 开发工具
- Git: 版本控制
- Conda: 环境管理
- CUDA: GPU 加速

## 部署要求
- NVIDIA GPU (推荐 8GB 以上显存)
- CUDA 12.1 支持
- 至少 16GB 系统内存
- 足够的磁盘空间用于模型存储

# 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

# 一致光照的施加

在 HDR 空间中，光照具有一个特性，即所有光传输都是独立的。 